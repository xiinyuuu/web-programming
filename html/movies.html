<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MovRec</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="../stylesheet/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg custom-navbar">
    <div class="container-fluid px-4">
      <a class="navbar-brand text-light" href="#">MovRec</a>
      <div class="collapse navbar-collapse justify-content-between">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="../html/home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="../html/movies.html">Movies</a></li>
          <li class="nav-item"><a class="nav-link" href="../html/actor.html">Actors</a></li>
          <li class="nav-item"><a class="nav-link" href="../html/watchlist.html">Watchlist</a></li>
        </ul>

        <form class="d-flex me-4" style="max-width: 300px;" onsubmit="handleSearch(event)">
          <div class="input-group">
            <input id="searchInput" class="form-control search-box" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-search" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </form>

        <script>
          function handleSearch(event) {
            event.preventDefault();
            const keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
              window.location.href = `../html/search.html?query=${encodeURIComponent(keyword)}`;
            }
          }
        </script>
        
          <a href="../html/profile.html"><img src="../images/profile.jpg" alt="Profile" class="rounded-circle profile-img"></a>
      </div>
    </div>
  </nav>

  <!-- Filter Section -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <div id="activeFilters"></div>
        <div class="dropdown">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown" aria-expanded="false" id="filterDropdown">
                <i class="bi bi-funnel"></i> Filter Movies
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Filter By</h6></li>
                <li><a class="dropdown-item" href="#" data-filter="genre" id="filterGenre">Genre</a></li>
                <li><a class="dropdown-item" href="#" data-filter="year" id="filterYear">Year</a></li>
                <li><a class="dropdown-item" href="#" data-filter="popular" id="filterPopular">Popularity</a></li>
                <li><a class="dropdown-item" href="#" data-filter="rating" id="filterRating">Rating</a></li>
                <li><a class="dropdown-item" href="#" data-filter="language" id="filterLanguage">Languages</a></li>
                <li><a class="dropdown-item" href="#" data-filter="country" id="filterCountry">Countries</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Sort By</h6></li>
                <li><a class="dropdown-item" href="#" data-sort="alphabetical">A to Z</a></li>
                <li><a class="dropdown-item" href="#" data-sort="reverse-alphabetical">Z to A</a></li>
                <li><a class="dropdown-item" href="#" data-sort="release-date">Release Date</a></li>
            </ul>
        </div>
    </div>
  </div>

  <!-- Movies Grid -->
  <div class="container mt-3">
    <div id="movieGrid" class="row row-cols-2 row-cols-sm-3 row-cols-md-5 row-cols-xl-7 g-4 justify-content-center">
        <!-- Movie cards will be injected here -->
    </div>

    <div class="text-center my-4">
        <button class="btn btn-outline-light me-2" id="prevBtn">
            <i class="bi bi-arrow-left"></i>
        </button>
        <button class="btn btn-outline-light" id="nextBtn">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>
  </div>

  <!-- Filter Modals -->
  <!-- Genre Filter Modal -->
  <div class="modal fade" id="genreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Genres</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="genre-checkboxes"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyGenreFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Year Filter Modal -->
  <div class="modal fade" id="yearModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Year Range (1990-2025)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between">
                    <input type="number" class="form-control me-2" id="startYear" 
                           placeholder="Start Year" min="1990" max="2025">
                    <input type="number" class="form-control" id="endYear" 
                           placeholder="End Year" min="1990" max="2025">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyYearFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Popularity Filter Modal -->
  <div class="modal fade" id="popularModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Popularity Range</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between">
                    <input type="number" class="form-control me-2" id="minPopularity" 
                           placeholder="Min" min="0">
                    <input type="number" class="form-control" id="maxPopularity" 
                           placeholder="Max" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyPopularityFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Rating Filter Modal -->
  <div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Rating Range (0-5)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between">
                    <input type="number" class="form-control me-2" id="minRating" 
                           placeholder="Min" step="0.1" min="0" max="5">
                    <input type="number" class="form-control" id="maxRating" 
                           placeholder="Max" step="0.1" min="0" max="5">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyRatingFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Language Filter Modal -->
  <div class="modal fade" id="languageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Languages</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="language-checkboxes"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyLanguageFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Country Filter Modal -->
  <div class="modal fade" id="countryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Countries</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="country-checkboxes"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="applyCountryFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center mt-5 p-4 footer">
    <div>
      MovRec &copy; 2025 All Rights Reserved &bull;
      <a href="mailto:movrec.support@example.com" class="footer-link">Contact Us</a>
    </div>
  </footer>

  <!-- Load roulette modal -->
  <div id="roulette-modal-container"></div>
  <script src="../javascript/roulette.js"></script>

  <!-- Floating Roulette Button -->
  <div class="roulette-button" data-bs-toggle="modal" data-bs-target="#rouletteModal">
    <img src="../images/roulette.png" alt="Roulette" class="roulette-icon">
  </div>

  <!-- Movie Data Script -->
  <script src="../javascript/moviedata.js"></script>
  <script src="../javascript/moviedetails.js"></script>

  <script>
    let currentPage = 1;
    const moviesPerPage = 35;
    let activeFilters = {
      genres: [],
      yearRange: null,
      popularityRange: null,
      ratingRange: null,
      languages: [],
      countries: [],
      sort: null
    };

    // Initialize genres
    const allGenres = ["Action", "Adventure", "Romance", "Drama", "Sci-Fi", "Comedy"];

    // Filter and Sort Functions
    function filterMovies(movies) {
      return movies.filter(movie => {
        // Genre filter
        if (activeFilters.genres.length > 0 && 
            !activeFilters.genres.some(genre => movie.genre.includes(genre))) return false;

        // Year filter
        if (activeFilters.yearRange && 
           (movie.year < activeFilters.yearRange.start || movie.year > activeFilters.yearRange.end)) return false;

        // Popularity filter
        if (activeFilters.popularityRange && 
           (movie.popularity < activeFilters.popularityRange.min || 
            movie.popularity > activeFilters.popularityRange.max)) return false;

        // Rating filter
        if (activeFilters.ratingRange && 
           (movie.rating < activeFilters.ratingRange.min || 
            movie.rating > activeFilters.ratingRange.max)) return false;

        // Language filter
        if (activeFilters.languages.length > 0 && 
            !activeFilters.languages.includes(movie.language)) return false;

        // Country filter
        if (activeFilters.countries.length > 0 && 
            !activeFilters.countries.includes(movie.country)) return false;
        return true;
      });
    }


    function sortMovies(movies) {
      if (!activeFilters.sort) return movies;
      return [...movies].sort((a, b) => {
        switch(activeFilters.sort) {
          case 'alphabetical': return a.title.localeCompare(b.title);
          case 'reverse-alphabetical': return b.title.localeCompare(a.title);
          case 'release-date': return b.year - a.year;
          default: return 0;
        }
      });
    }

    // UI Update Functions
    function updateActiveFiltersDisplay() {
      const container = document.getElementById('activeFilters');
      const filters = [];
      
      if (activeFilters.genres.length > 0) {
        filters.push(`Genres: ${activeFilters.genres.join(', ')}`);
      }
      
      if (activeFilters.yearRange) {
        filters.push(`Years: ${activeFilters.yearRange.start}-${activeFilters.yearRange.end}`);
      }

      if (activeFilters.popularityRange) {
        filters.push(`Popularity: ${activeFilters.popularityRange.min}-${activeFilters.popularityRange.max}`);
      }

      if (activeFilters.ratingRange) {
        filters.push(`Rating: ${activeFilters.ratingRange.min}-${activeFilters.ratingRange.max}`);
      }

      if (activeFilters.languages.length > 0) {
        filters.push(`Languages: ${activeFilters.languages.join(', ')}`);
      }

      if (activeFilters.countries.length > 0) {
        filters.push(`Countries: ${activeFilters.countries.join(', ')}`);
      }

      if (activeFilters.sort) {
        filters.push(`Sorted by: ${activeFilters.sort.replace('-', ' ')}`);
      }

      container.innerHTML = filters.map(f => `
        <span class="badge bg-secondary me-2">
          ${f} <button class="btn-close btn-close-white ms-2" 
                  onclick="clearFilter('${f.split(': ')[0].toLowerCase()}')"></button>
        </span>
      `).join('');
    }

    window.clearFilter = (filterType) => {
      switch(filterType) {
        case 'genres':
          activeFilters.genres = [];
          break;
        case 'years':
          delete activeFilters.yearRange;
          break;
        case 'popularity':
          delete activeFilters.popularityRange;
          break;
        case 'rating':
          delete activeFilters.ratingRange;
          break;
        case 'languages':
          activeFilters.languages = [];
          break;
        case 'countries':

          activeFilters.countries = [];
          break;
        case 'sorted by':
          activeFilters.sort = null;
          break;
      }
      updateActiveFiltersDisplay();
      renderMovies();
    };


    function storeMovie(movie) {
      sessionStorage.setItem('selectedMovie', JSON.stringify(movie));
    }


    // Rendering
    function renderMovies() {
      const grid = document.getElementById('movieGrid');
      grid.innerHTML = '';


      const start = (currentPage - 1) * moviesPerPage;
      const end = start + moviesPerPage;
      const moviesToShow = movies.slice(start, end);

      moviesToShow.forEach(movie => {
        const col = document.createElement('div');
        col.className = 'col';

        const card = document.createElement('div');
        card.className = 'card movie-card text-center';
        card.innerHTML = `
          <img src="${movie.img}" class="card-img-top movie-img" alt="${movie.title}">
          <div class="card-body p-1">
            <h6 class="movie-title">${movie.title}</h6>
          </div>
        `;

        // Wrap card in link
        const link = document.createElement('a');
        link.href = '../html/moviedesc.html';
        link.className = 'text-decoration-none text-light';

        // Set movie object in sessionStorage on click
        link.addEventListener('click', () => {
          sessionStorage.setItem('selectedMovie', JSON.stringify(movie));
        });

        link.appendChild(card);
        col.appendChild(link);
        grid.appendChild(col);
      });

      document.getElementById('prevBtn').disabled = currentPage === 1;
    }


    function displayHardcodedMovies(movies) {
      const container = document.getElementById("movieGrid");
      container.innerHTML = "";

      let filteredMovies = filterMovies(movies);
      filteredMovies = sortMovies(filteredMovies);

      const start = (currentPage - 1) * moviesPerPage;
      const end = start + moviesPerPage;
      const moviesToShow = filteredMovies.slice(start, end);

      moviesToShow.forEach(movie => {
        const col = document.createElement("div");
        col.className = 'col';

        const card = document.createElement("div");
        card.className = 'card movie-card text-center';

        card.innerHTML = `
          <img src="../images/${movie.img}" class="card-img-top movie-img" alt="${movie.title}">
          <div class="card-body p-1">
            <h6 class="movie-title">${movie.title}</h6>
          </div>
        `;

        const link = document.createElement("a");
        link.href = "../html/moviedesc.html";
        link.className = "text-decoration-none text-light";

        link.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            const response = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(movie.title)}`);
            const data = await response.json();
            const selected = data.results.find(result => result.title.toLowerCase() === movie.title.toLowerCase());

            if (selected) {
              sessionStorage.setItem("selectedMovie", JSON.stringify(selected));
              window.location.href = link.href;
            } else {
              alert("Movie not found in TMDB!");
            }
          } catch (error) {
            console.error("Error fetching from TMDB:", error);
          }
        });

        link.appendChild(card);
        col.appendChild(link);
        container.appendChild(col);
      });
        document.getElementById('prevBtn').disabled = currentPage === 1;
    }




    // Event listeners
    document.getElementById('filterGenre').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('genreModal')).show();
    });

    document.getElementById('applyGenreFilter').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.genre-checkboxes input:checked');
      activeFilters.genres = Array.from(checkboxes).map(cb => cb.value);
      updateActiveFiltersDisplay();
      currentPage = 1;
      displayHardcodedMovies(hardcodedMovies);
      new bootstrap.Modal(document.getElementById('genreModal')).hide();
    });

    document.getElementById('filterYear').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('yearModal')).show();
    });

    document.getElementById('applyYearFilter').addEventListener('click', () => {
      let startYear = parseInt(document.getElementById('startYear').value) || 1990;
      let endYear = parseInt(document.getElementById('endYear').value) || 2025;

      // Enforce range constraints
      startYear = Math.max(1990, Math.min(startYear, 2025));
      endYear = Math.max(1990, Math.min(endYear, 2025));
      
      // Ensure valid range
      if (startYear > endYear) [startYear, endYear] = [endYear, startYear];

      activeFilters.yearRange = { start: startYear, end: endYear };
      updateActiveFiltersDisplay();
      currentPage = 1;
      displayHardcodedMovies(hardcodedMovies);
      new bootstrap.Modal(document.getElementById('yearModal')).hide();
    });

    document.getElementById('filterPopular').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('popularModal')).show();
    });

    document.getElementById('applyPopularityFilter').addEventListener('click', () => {
      const min = parseInt(document.getElementById('minPopularity').value) || 0;
      const max = parseInt(document.getElementById('maxPopularity').value) || Infinity;
      activeFilters.popularityRange = { min, max };
      updateActiveFiltersDisplay();
      currentPage = 1;
      displayHardcodedMovies(hardcodedMovies);
      new bootstrap.Modal(document.getElementById('popularModal')).hide();
    });

    document.getElementById('filterRating').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('ratingModal')).show();
    });

    document.getElementById('applyRatingFilter').addEventListener('click', () => {
      const min = parseFloat(document.getElementById('minRating').value) || 0;
      const max = parseFloat(document.getElementById('maxRating').value) || 5;
      activeFilters.ratingRange = { 
        min: Math.max(0, Math.min(min, 5)),
        max: Math.max(0, Math.min(max, 5))
      };
      updateActiveFiltersDisplay();
      currentPage = 1;
      displayHardcodedMovies(hardcodedMovies);
      new bootstrap.Modal(document.getElementById('ratingModal')).hide();
    });

    document.getElementById('filterLanguage').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('languageModal')).show();
    });

    document.getElementById('applyLanguageFilter').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.language-checkboxes input:checked');
      activeFilters.languages = Array.from(checkboxes).map(cb => cb.value);
      updateActiveFiltersDisplay();
      currentPage = 1;
      displayHardcodedMovies(hardcodedMovies);
    });

    document.getElementById('filterCountry').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('countryModal')).show();
    });

    document.getElementById('applyCountryFilter').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.country-checkboxes input:checked');
      activeFilters.countries = Array.from(checkboxes).map(cb => cb.value);
      updateActiveFiltersDisplay();
      currentPage = 1;
      displayHardcodedMovies(hardcodedMovies);
      new bootstrap.Modal(document.getElementById('countryModal')).hide();
    });

    document.querySelectorAll('[data-sort]').forEach(item => {
      item.addEventListener('click', () => {
        activeFilters.sort = item.getAttribute('data-sort');
        updateActiveFiltersDisplay();
        displayHardcodedMovies(hardcodedMovies);
      });
    });

    // Pagination Controls
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderMovies();
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      const filteredMovies = filterMovies(movies);
      if ((currentPage * moviesPerPage) < filteredMovies.length) {
        currentPage++;
        renderMovies();
      }
    });

    // Initialization
    function populateGenres() {
      const container = document.querySelector('.genre-checkboxes');
      container.innerHTML = allGenres.map(genre => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${genre}" id="${genre}">
          <label class="form-check-label" for="${genre}">${genre}</label>
        </div>
      `).join('');
    }

    function populateLanguages() {
      const allLanguages = [...new Set(hardcodedMovies.map(movie => movie.language))];
      const container = document.querySelector('.language-checkboxes');
      container.innerHTML = allLanguages.map(language => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${language}" id="${language}">
          <label class="form-check-label" for="${language}">${language}</label>
        </div>
      `).join('');
    }

    function populateCountries() {
      const allCountries = [...new Set(hardcodedMovies.map(movie => movie.country))];
      const container = document.querySelector('.country-checkboxes');
      container.innerHTML = allCountries.map(country => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${country}" id="${country}">
          <label class="form-check-label" for="${country}">${country}</label>
        </div>
      `).join('');
    }

    // Initial render
    populateGenres();
    populateLanguages();
    populateCountries();
    renderMovies();
  </script>
  
</body>
</html>