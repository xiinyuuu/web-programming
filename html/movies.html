<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MovRec - Movies</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/stylesheet/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg custom-navbar">
    <div class="container-fluid px-4">
      <a class="navbar-brand text-light" href="#">MovRec</a>
      <div class="collapse navbar-collapse justify-content-between">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="/movies.html">Movies</a></li>
          <li class="nav-item"><a class="nav-link" href="/actor.html">Actors</a></li>
          <li class="nav-item"><a class="nav-link" href="/watchlist.html">Watchlist</a></li>
        </ul>

        <form class="d-flex me-4" style="max-width: 300px;" onsubmit="handleSearch(event)">
          <div class="input-group">
            <input id="searchInput" class="form-control search-box" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-search" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </form>

        <script>
          // This search function remains as it correctly redirects to your search page
          function handleSearch(event) {
            event.preventDefault();
            const keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
              window.location.href = `../html/search.html?query=${encodeURIComponent(keyword)}`;
            }
          }
        </script>
        
        <a href="/profile.html"><img src="/images/profile.jpg" alt="Profile" class="rounded-circle profile-img"></a>
      </div>
    </div>
  </nav>

  <!-- Filter Section -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <div id="activeFiltersDisplay"></div>
        <div class="dropdown">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown" aria-expanded="false" id="filterDropdown">
                <i class="bi bi-funnel"></i> Filter & Sort
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Filter By</h6></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#genreModal">Genre</a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#yearModal">Year</a></li>
                <!-- Other filters can be re-added here if needed -->
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Sort By</h6></li>
                <li><a class="dropdown-item" href="#" data-sort="popularity.desc">Popularity</a></li>
                <li><a class="dropdown-item" href="#" data-sort="vote_average.desc">Rating</a></li>
                <li><a class="dropdown-item" href="#" data-sort="primary_release_date.desc">Release Date</a></li>
                <li><a class="dropdown-item" href="#" data-sort="original_title.asc">A to Z</a></li>
                <li><a class="dropdown-item" href="#" data-sort="original_title.desc">Z to A</a></li>
            </ul>
        </div>
    </div>
  </div>

  <!-- Movies Grid -->
  <div class="container mt-3">
    <div id="movieGrid" class="row row-cols-2 row-cols-sm-3 row-cols-md-5 row-cols-xl-7 g-4 justify-content-center">
        <!-- Movie cards will be injected here by JavaScript -->
    </div>

    <!-- Pagination -->
    <div class="text-center my-4">
        <button class="btn btn-outline-light me-2" id="prevBtn">
            <i class="bi bi-arrow-left"></i>
        </button>
        <span id="pageIndicator" class="text-light mx-2">Page 1</span>
        <button class="btn btn-outline-light" id="nextBtn">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>
  </div>

  <!-- Filter Modals -->
  <!-- Genre Filter Modal -->
  <div class="modal fade" id="genreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Genres</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Genre checkboxes will be populated here -->
                <div class="genre-checkboxes"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="clearGenreFilter">Clear</button>
                <button type="button" class="btn btn-primary" id="applyGenreFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Year Filter Modal -->
  <div class="modal fade" id="yearModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Select Year Range</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between">
                    <input type="number" class="form-control me-2" id="startYear" placeholder="Start Year (e.g., 1990)">
                    <input type="number" class="form-control" id="endYear" placeholder="End Year (e.g., 2024)">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="clearYearFilter">Clear</button>
                <button type="button" class="btn btn-primary" id="applyYearFilter" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center mt-5 p-4 footer">
    <div>
      MovRec © 2024 All Rights Reserved •
      <a href="mailto:movrec.support@example.com" class="footer-link">Contact Us</a>
    </div>
  </footer>
  
  <!-- Floating Roulette Button -->
  <!-- This assumes you have a roulette.js file for its functionality -->
  <div id="roulette-modal-container"></div>
  <script src="/javascript/roulette.js"></script>
  <div class="roulette-button" data-bs-toggle="modal" data-bs-target="#rouletteModal">
    <img src="/images/roulette.png" alt="Roulette" class="roulette-icon">
  </div>
  
  <script>
    // --- SETUP & STATE ---
    const API_KEY = 'b855267d7a05ecc45792618a1e73a27b';
    const MOVIE_GRID = document.getElementById('movieGrid');
    const PREV_BTN = document.getElementById('prevBtn');
    const NEXT_BTN = document.getElementById('nextBtn');
    const PAGE_INDICATOR = document.getElementById('pageIndicator');
    const ACTIVE_FILTERS_DISPLAY = document.getElementById('activeFiltersDisplay');

    let currentPage = 1;
    let totalPages = 1;
    let genreIdToNameMap = {}; // To store {id: name} for genres

    let activeFilters = {
        genres: [],
        yearRange: null,
        sort: 'popularity.desc'
    };

    // Connect to  API 

    async function fetchAndDisplayMovies() {
        let apiUrl = `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&language=en-US&page=${currentPage}&vote_count.gte=100`; // vote_count filter for quality

        if (activeFilters.genres.length > 0) {
            apiUrl += `&with_genres=${activeFilters.genres.join(',')}`;
        }
        if (activeFilters.yearRange) {
            apiUrl += `&primary_release_date.gte=${activeFilters.yearRange.start}-01-01`;
            apiUrl += `&primary_release_date.lte=${activeFilters.yearRange.end}-12-31`;
        }
        if (activeFilters.sort) {
            apiUrl += `&sort_by=${activeFilters.sort}`;
        }
        
        try {
            MOVIE_GRID.innerHTML = `<div class="text-light text-center w-100"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const data = await response.json();
            
            displayMovies(data.results);
            totalPages = Math.min(data.total_pages, 500); // TMDB limits results to 500 pages
            updatePagination();

        } catch (error) {
            console.error("Failed to fetch movies:", error);
            MOVIE_GRID.innerHTML = `<p class="text-light text-center w-100">Failed to load movies. Please try again later.</p>`;
        }
    }

    function displayMovies(movies) {
        MOVIE_GRID.innerHTML = '';
        if (movies.length === 0) {
            MOVIE_GRID.innerHTML = `<p class="text-light text-center w-100">No movies found matching your criteria.</p>`;
            return;
        }

        movies.forEach(movie => {
            const col = document.createElement('div');
            col.className = 'col';

            const card = document.createElement('div');
            card.className = 'card movie-card text-center';
            
            const posterPath = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` 
                : 'https://via.placeholder.com/500x750?text=No+Poster';

            card.innerHTML = `
              <img src="${posterPath}" class="card-img-top movie-img" alt="${movie.title}">
              <div class="card-body p-1">
                <h6 class="movie-title">${movie.title}</h6>
              </div>
            `;

            const link = document.createElement('a');
            link.href = '/moviedesc.html';
            link.className = 'text-decoration-none text-light';

            link.addEventListener('click', (e) => {
                sessionStorage.setItem('selectedMovie', JSON.stringify(movie));
            });

            link.appendChild(card);
            col.appendChild(link);
            MOVIE_GRID.appendChild(col);
        });
    }

    // Filtering and Sorting

    async function populateGenreFilter() {
        try {
            const response = await fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${API_KEY}&language=en-US`);
            const data = await response.json();
            genreIdToNameMap = data.genres.reduce((map, genre) => {
                map[genre.id] = genre.name;
                return map;
            }, {});

            const genreContainer = document.querySelector('.genre-checkboxes');
            genreContainer.innerHTML = data.genres.map(genre => `
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="${genre.id}" id="genre-${genre.id}">
                  <label class="form-check-label" for="genre-${genre.id}">${genre.name}</label>
                </div>
            `).join('');
        } catch (error) {
            console.error("Failed to populate genres:", error);
        }
    }

    function updateActiveFiltersDisplay() {
        let filtersHtml = '';
        if (activeFilters.genres.length > 0) {
            const genreNames = activeFilters.genres.map(id => genreIdToNameMap[id] || id).join(', ');
            filtersHtml += `<span class="badge bg-secondary me-2">Genres: ${genreNames}</span>`;
        }
        if (activeFilters.yearRange) {
            filtersHtml += `<span class="badge bg-secondary me-2">Years: ${activeFilters.yearRange.start}-${activeFilters.yearRange.end}</span>`;
        }
        ACTIVE_FILTERS_DISPLAY.innerHTML = filtersHtml;
    }

    function updatePagination() {
        PAGE_INDICATOR.textContent = `Page ${currentPage}`;
        PREV_BTN.disabled = currentPage === 1;
        NEXT_BTN.disabled = currentPage >= totalPages;
    }

    // Event Listeners
    
    document.addEventListener('DOMContentLoaded', () => {
        populateGenreFilter();
        fetchAndDisplayMovies();
    });

    // Filter Apply Buttons
    document.getElementById('applyGenreFilter').addEventListener('click', () => {
        const checkedBoxes = document.querySelectorAll('.genre-checkboxes input:checked');
        activeFilters.genres = Array.from(checkedBoxes).map(cb => cb.value);
        currentPage = 1;
        fetchAndDisplayMovies();
        updateActiveFiltersDisplay();
    });
    document.getElementById('clearGenreFilter').addEventListener('click', () => {
        activeFilters.genres = [];
        document.querySelectorAll('.genre-checkboxes input:checked').forEach(cb => cb.checked = false);
        currentPage = 1;
        fetchAndDisplayMovies();
        updateActiveFiltersDisplay();
    });

    document.getElementById('applyYearFilter').addEventListener('click', () => {
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        if (startYear && endYear && parseInt(startYear) <= parseInt(endYear)) {
            activeFilters.yearRange = { start: startYear, end: endYear };
            currentPage = 1;
            fetchAndDisplayMovies();
            updateActiveFiltersDisplay();
        } else if (startYear || endYear) {
            alert("Please enter a valid start and end year.");
        }
    });
    document.getElementById('clearYearFilter').addEventListener('click', () => {
        activeFilters.yearRange = null;
        document.getElementById('startYear').value = '';
        document.getElementById('endYear').value = '';
        currentPage = 1;
        fetchAndDisplayMovies();
        updateActiveFiltersDisplay();
    });

    // Sort Dropdown
    document.querySelectorAll('[data-sort]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            activeFilters.sort = item.dataset.sort;
            currentPage = 1;
            fetchAndDisplayMovies();
        });
    });

    // Pagination
    PREV_BTN.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            fetchAndDisplayMovies();
        }
    });

    NEXT_BTN.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            fetchAndDisplayMovies();
        }
    });
  </script>
</body>
</html>